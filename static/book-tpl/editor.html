<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>screenshot-api-server</title>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="//cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/codemirror.min.css" rel="stylesheet">
    <link href="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/theme/darcula.min.css" rel="stylesheet">
<!--    <link href="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/theme/eclipse.min.css" rel="stylesheet">-->
<!--    <link href="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/theme/base16-dark.min.css" rel="stylesheet">-->

<!--    <link href="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/addon/lint/lint.min.css" rel="stylesheet">-->
<!--    <link href="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.min.css" rel="stylesheet">-->

    
    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/codemirror.min.js"></script>

    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/mode/css/css.js"></script>
<!--    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/mode/htmlmixed/htmlmixed.min.js"></script>-->
    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/mode/javascript/javascript.min.js"></script>
    
<!--    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/addon/lint/lint.js"></script>-->
<!--    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/addon/hint/show-hint.min.js"></script>-->
<!--    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/addon/lint/json-lint.min.js"></script>-->
<!--    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/addon/hint/html-hint.min.js"></script>-->
<!--    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/addon/lint/css-lint.min.js"></script>-->
    <script src="//cdn.bootcdn.net/ajax/libs/codemirror/5.62.2/mode/xml/xml.min.js"></script>



    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/lodash.min.js"></script>
    
    <style>
        body {
            color: #000;
            font-family: "Microsoft YaHei UI", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-weight: 400;
        }

        html,body{
            height:100%;
        }
        .container-fluid{
            height:100%;
            background-color: rgb(43,43,43);
        }
        
        .label-el {
            color: white;
            text-align: center;
            font-size: 16px;
            padding: 5px;
        }
        
        .value-el{
            height: calc(100% - 20px);
        }
        .value-el .textarea{
            width: 100%;height: calc(100% - 20px);
            margin: 20px 0;
        }

        .CodeMirror{
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row" style="height: 50px;">
            <div class="col-xs-4" style="height: 100%; font-size: 18px;color: white;line-height: 50px;">
                bookjs-eazy模板生成PDF在线编辑
            </div>
        </div>
        <div class="row" style="height: calc(100% - 50px)">
            <div class="col-xs-4" style="height: 100%;">
                <div class="row" style="height: 33.3%;background-color: #db7f37;">
                    <div class="col-xs-12 label-el">样&nbsp;&nbsp;&nbsp;&nbsp;式 (bookStyle)</div>
                    <div class="col-xs-12 value-el" style="">
                        <div class="row" style="height: 100%;">
                                <textarea name="bookStyle" style="width: 100%;height: 100%">
                            </textarea>
                        </div>
                    </div>
                </div>
                <div class="row" style="height: 33.3%;background-color: #0d8050;">
                    <div class="col-xs-12 label-el">模&nbsp;&nbsp;&nbsp;&nbsp;板 (bookTpl)</div>
                    <div class="col-xs-12 value-el" style="">
                        <div class="row" style="height: 100%;">
                            <textarea name="bookTpl" style="width: 100%;height: 100%"></textarea>
                        </div>
                    </div>
                </div>
                <div class="row" style="height: 33.3%;background-color: #376ddb;">
                    <div class="col-xs-12 label-el">配&nbsp;&nbsp;&nbsp;&nbsp;置 (bookConfig)</div>
                    <div class="col-xs-12 value-el" style="">
                        <div class="row" style="height: 100%;">
                            <textarea name="bookConfig" style="width: 100%;height: 100%"></textarea>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-xs-8"  style="height: 100%">
                <div class="row"  style="height: 100%">
                    <iframe id="show-el" sandbox="allow-downloads allow-top-navigation allow-scripts allow-modals" style="width: 100%;height: 100%;background: #999;">
                        <p>不支持SRCDOC属性</p>
                    </iframe>
                </div>
            </div>
        </div>
    </div>
    <script>
        bookStyleInput = $('[name=bookStyle]');
        bookConfigInput = $('[name=bookConfig]');
        bookTplInput = $('[name=bookTpl]');
         let resetBook = function() {
            let bookConfigStr = $.trim(bookConfigInput.val());
            let bookConfig;
            try{
                bookConfig = JSON.parse(bookConfigStr);
            }catch (e) {
                return;
            }

            bookConfig.start = true;
            bookConfigStr = JSON.stringify(bookConfig,null,2);

            let bookStyle = $.trim(bookStyleInput.val());
            let bookStyleStr = JSON.stringify(bookStyle);
            let bookTpl = $.trim(bookTplInput.val());

            let endScriptTag = '<\/script>';
            let baseUrl = location.origin + '/';
            let htmlContent = `<!DOCTYPE html>
<html lang="zh-cmn-Hans">
    <head>
        <meta charset="UTF-8">
        <title>screenshot-api-server</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <meta name="renderer" content="webkit">
        <meta name="format-detection" content="telephone=no">
        <base href="${baseUrl}" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0">
        <script src="/static/js/polyfill.min.js">${endScriptTag}
        <script src="/static/js/jquery.min.js">${endScriptTag}
        <script src="/static/js/lodash.min.js">${endScriptTag}
        <script src="/static/js/bookjs/latest/bookjs-eazy.min.js">${endScriptTag}
    </head>
    <body>
        <style id="book-style" type="text/css" rel="stylesheet"></style>
        <div id="content-box" style="display: none">${bookTpl}</div>
        <script>
            document.getElementById('book-style').appendChild(document.createTextNode(${bookStyleStr}));
        ${endScriptTag}
        <script>
            bookConfig = ${bookConfigStr};
        ${endScriptTag}
    </body>
</html>`;

            let  blobUrl =  'data:text/html;base64,' + btoa(unescape(encodeURIComponent(htmlContent)));
            // let blobUrl = URL.createObjectURL(new Blob([htmlContent], {
            //     type: 'text/html'
            // }));
            $('#show-el').prop('src',blobUrl);
            let params = {
                bookTpl: bookTpl,
                bookConfig: bookConfig,
                bookStyle: bookStyle,
            };
            console.log(params)
        };
        
        let changeCallback = _.debounce(function(editor,changeObj){
            editor.save();

            resetBook();
        },2000);
        var editorBookStyle = CodeMirror.fromTextArea(bookStyleInput.get(0), {
             lineNumbers: true,
             mode: "css",
             indentUnit: 4,
             theme: "darcula",
             //lint: true,
             matchBrackets: true,    //括号匹配
         });
         editorBookStyle.on('change',changeCallback);
        
         var editorBookTpl = CodeMirror.fromTextArea(bookTplInput.get(0), {
             lineNumbers: true,
             mode: "text/html",
             indentUnit: 4,
             theme: "darcula",
             //lint: true,
             matchBrackets: true,    //括号匹配
         });
         editorBookTpl.on('change',changeCallback);
        
         var editorBookConfig = CodeMirror.fromTextArea(bookConfigInput.get(0), {
             lineNumbers: true,
             mode: "application/json",
             indentUnit: 4,
             foldGutter: true,
             theme: "darcula",
             lint: true,
             matchBrackets: true,    //括号匹配
        });
         editorBookConfig.on('change',changeCallback);

         var d1 = $.ajax({url: './demo/bookConfig.json',type: 'GET', dataType:'text'}).then(function(d){
             editorBookConfig.setValue(d);
             bookConfigInput.val(d);
         });

         var d2 = $.ajax({url: './demo/bookStyle.css',type: 'GET', dataType:'text'}).then(function(d){
             editorBookStyle.setValue(d);
             bookStyleInput.val(d);
         });

         var d3 = $.ajax({url: './demo/bookTpl.html',type: 'GET', dataType:'text'}).then(function(d){
             editorBookTpl.setValue(d);
             bookTplInput.val(d)
         });
         
         // $.when(
         //     d1,d2,d3
         // ).then(function(){
         //     resetBook();
         // })
    </script>
</body>
</html>
